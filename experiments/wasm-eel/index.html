<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Butterchurn Demo</title>
  <meta name="description" content="Butterchurn Demo Example">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script type="text/javascript" src="../../lib/butterchurn.js"></script>
  <script type="text/javascript" src="https://unpkg.com/lodash"></script>
  <!-- <script type="text/javascript" src="https://unpkg.com/butterchurn"></script> -->
  <script
    src="https://code.jquery.com/jquery-3.1.1.min.js"
    integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
    crossorigin="anonymous"></script>

  <style>
    #canvas:-moz-full-screen {
      width: 100%;
      height: 100%;
    }
    #canvas:-webkit-full-screen {
      width: 100%;
      height: 100%;
    }
    #canvas:-ms-fullscreen {
      width: 100%;
      height: 100%;
    }
    #canvas:fullscreen {
      width: 100%;
      height: 100%;
    }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/normalize.css/normalize.css" />

  <script>
    $(function() {
      var visualizer = null;
      var rendering = false;
      var audioContext = null;
      var sourceNode = null;
      var delayedAudible = null;
      const presetNames = [
        'fiShbRaiN - witchcraft.json',
        'Geiss - Feedback 2.json',
        'Flexi - Fishies!.json',
        "$$$ Royal - Mashup (197).json",
        "$$$ Royal - Mashup (220).json",
        "$$$ Royal - Mashup (431).json",
        "_Aderrasi - Wanderer in Curved Space - mash0000 - faclempt kibitzing meshuggana schmaltz (Geiss color mix).json",
        "_Geiss - Artifact 01.json",
        "_Geiss - Desert Rose 2.json",
        "_Geiss - untitled.json",
        "_Mig_049.json",
        "_Mig_085.json",
        "_Rovastar + Geiss - Hurricane Nightmare (Posterize Mix).json",
        "Aderrasi + Geiss - Airhandler (Kali Mix) - Canvas Mix.json",
        "Aderrasi - Potion of Spirits.json",
        "Aderrasi - Songflower (Moss Posy).json",
        "Aderrasi - Storm of the Eye (Thunder) - mash0000 - quasi pseudo meta concentrics.json",
        "An AdamFX n Martin Infusion 2 flexi - Why The Sky Looks Diffrent Today - AdamFx n Martin Infusion - Tack Tile Disfunction B.json",
        "cope + martin - mother-of-pearl.json",
        "Cope - The Neverending Explosion of Red Liquid Fire.json",
        "Eo.S. + Phat - cubetrace - v2.json",
        "Eo.S. + Zylot - skylight (Stained Glass Majesty mix).json",
        "Eo.S. - glowsticks v2 05 and proton lights (+Krash′s beat code) _Phat_remix02b.json",
        "fiShbRaiN + Flexi - witchcraft 2.0.json",
        "flexi + amandio c - organic [random mashup].json",
        // "flexi + amandio c - organic12-3d-2.milk.json",
        "Flexi + amandio c - piercing 05 - Kopie (2) - Kopie.json",
        "flexi + fishbrain - neon mindblob grafitti.json",
        "flexi + geiss - pogo cubes vs. tokamak vs. game of life [stahls jelly 4.5 finish].json",
        "Flexi + Martin - astral projection.json",
        "Flexi + Martin - cascading decay swing.json",
        "Flexi + stahlregen - jelly showoff parade.json",
        "Flexi - alien fish pond.json",
        "Flexi - area 51.json",
        "flexi - bouncing balls [double mindblob neon mix].json",
        "Flexi - infused with the spiral.json",
        "Flexi - mindblob [shiny mix].json",
        "Flexi - mindblob mix.json",
        "flexi - mom, why the sky looks different today.json",
        "flexi - patternton, district of media, capitol of the united abstractions of fractopia.json",
        "Flexi - predator-prey-spirals.json",
        "Flexi - smashing fractals [acid etching mix].json",
        "flexi - swing out on the spiral.json",
        "Flexi - truly soft piece of software - this is generic texturing (Jelly) .json",
        "flexi - what is the matrix.json",
        "Flexi, fishbrain, Geiss + Martin - tokamak witchery.json",
        "Flexi, martin + geiss - dedicated to the sherwin maxawow.json",
        "Fumbling_Foo & Flexi, Martin, Orb, Unchained - Star Nova v7b.json",
        "Geiss + Flexi + Martin - disconnected.json",
        "Geiss - Cauldron - painterly 2 (saturation remix).json",
        "Geiss - Reaction Diffusion 2.json",
        "Geiss - Spiral Artifact.json",
        "Geiss - Thumb Drum.json",
        "Geiss, Flexi + Stahlregen - Thumbdrum Tokamak [crossfiring aftermath jelly mashup].json",
        "Goody - The Wild Vort.json",
        "high-altitude basket unraveling - singh grooves nitrogen argon nz+.json",
        "Idiot - Star Of Annon.json",
        "Krash + Illusion - Spiral Movement.json",
        "martin + flexi - diamond cutter [prismaticvortex.com] - camille - i wish i wish i wish i was constrained.json",
        "Martin - acid wiring.json",
        "martin - angel flight.json",
        "martin - another kind of groove.json",
        "martin - bombyx mori.json",
        "martin - castle in the air.json",
        "martin - chain breaker.json",
        "Martin - charisma.json",
        "martin - disco mix 4.json",
        "martin - extreme heat.json",
        "martin - frosty caves 2.json",
        "martin - fruit machine.json",
        "martin - ghost city.json",
        "martin - glass corridor.json",
        "martin - infinity (2010 update).json",
        "Martin - liquid arrows.json",
        "martin - mandelbox explorer - high speed demo version.json",
        "martin - mucus cervix.json",
        "Martin - QBikal - Surface Turbulence IIb.json",
        "martin - reflections on black tiles.json",
        "martin - stormy sea (2010 update).json",
        "martin - The Bridge of Khazad-Dum.json",
        "martin - witchcraft reloaded.json",
        "martin [shadow harlequins shape code] - fata morgana.json",
        "martin, flexi, fishbrain + sto - enterstate [random mashup].json",
        "Milk Artist At our Best - FED - SlowFast Ft AdamFX n Martin - HD CosmoFX.json",
        "ORB - Waaa.json",
        "Phat+fiShbRaiN+Eo.S_Mandala_Chasers_remix.json",
        "Rovastar + Loadus + Geiss - FractalDrop (Triple Mix).json",
        "Rovastar - Oozing Resistance.json",
        "sawtooth grin roam.json",
        "shifter - dark tides bdrv mix 2.json",
        "suksma - heretical crosscut playpen.json",
        "suksma - Rovastar - Sunflower Passion (Enlightment Mix)_Phat_edit + flexi und martin shaders - circumflex in character classes in regular expression.json",
        "suksma - uninitialized variabowl (hydroponic chronic).json",
        "suksma - vector exp 1 - couldn′t not.json",
        "TonyMilkdrop - Leonardo Da Vinci's Balloon [Flexi - merry-go-round + techstyle].json",
        "TonyMilkdrop - Magellan's Nebula [Flexi - you enter first + multiverse].json",
        "Unchained & Rovastar - Wormhole Pillars (Hall of Shadows mix).json",
        "Unchained - Rewop.json",
        "Unchained - Unified Drag 2.json",
        "yin - 191 - Temporal singularities.json",
        "Zylot - Paint Spill (Music Reactive Paint Mix).json",
        "Zylot - Star Ornament.json",
        "Zylot - True Visionary (Final Mix).json",
      ];
      var parsedPresets = null;
      var currPresetIdx = null;
      let frameNum = 0;
      let timeHist = [0];
      const timeHistMax = 120;
      var canvas = document.getElementById('canvas');

      function connectToAudioAnalyzer(sourceNode) {
        if(delayedAudible) {
          delayedAudible.disconnect();
        }

        delayedAudible = audioContext.createDelay();
        delayedAudible.delayTime.value = 0.26;

        sourceNode.connect(delayedAudible)
        delayedAudible.connect(audioContext.destination);

        visualizer.connectAudio(delayedAudible);
      }

      function startRenderer() {
        requestAnimationFrame(() => {
          startRenderer();
        });
        frameNum += 1;
        const renderStart = performance.now();
        visualizer.render();
        const renderEnd = performance.now();
        const elapsed = (renderEnd - renderStart) / 1000;
        const newHistTime = timeHist[timeHist.length - 1] + elapsed;
        timeHist.push(newHistTime);
        if (timeHist.length > timeHistMax) {
          timeHist.shift();
        }
        if (frameNum % timeHistMax === 0) {
          const fps = timeHist.length / (newHistTime - timeHist[0]);
          const useWasm = $('#useWASM').is(':checked');
          const presetName = presetNames[currPresetIdx];
          console.log(
            'FPS:', fps,
            ', WASM:' , useWasm,
            ', name:', presetName);
        }
      }

      function playBufferSource(buffer) {
        if (!rendering) {
          rendering = true;
          startRenderer();
        }

        if (sourceNode) {
          sourceNode.disconnect();
        }

        sourceNode = audioContext.createBufferSource();
        sourceNode.buffer = buffer;
        connectToAudioAnalyzer(sourceNode);

        sourceNode.start(0);
      }

      function loadRemoteFile(url) {
        if (!rendering) {
          rendering = true;
          startRenderer();
        }
        audioContext.resume();
        const audio = new Audio();
        audio.crossOrigin = "anonymous";
        audio.src = url;
        if (sourceNode) {
          sourceNode.disconnect();
        }
        sourceNode = audioContext.createMediaElementSource(audio);
        connectToAudioAnalyzer(sourceNode);
        audio.play();
      }

      function loadLocalFiles(files, index = 0) {
        audioContext.resume();

        var reader = new FileReader();
        reader.onload = (event) => {
          audioContext.decodeAudioData(
            event.target.result,
            (buf) => {
              playBufferSource(buf);

              setTimeout(() => {
                if (files.length > index + 1) {
                  loadLocalFiles(files, index + 1);
                } else {
                  sourceNode.disconnect();
                  sourceNode = null;
                  $("#audioSelectWrapper").css('display', 'block');
                }
              }, buf.duration * 1000);
            }
          );
        };

        var file = files[index];
        reader.readAsArrayBuffer(file);
      }

      function connectMicAudio(sourceNode, audioContext) {
        audioContext.resume();

        var gainNode = audioContext.createGain();
        gainNode.gain.value = 1.25;
        sourceNode.connect(gainNode);

        visualizer.connectAudio(gainNode);
        startRenderer();
      }

      $("#remoteFileBut").click(function() {
        $("#audioSelectWrapper").css('display', 'none');
        loadRemoteFile("https://raw.githubusercontent.com/captbaritone/webamp-music/4b556fbf/Just_Plain_Ant_-_05_-_Stumble.mp3");
      });

      $("#localFileBut").click(function() {
        $("#audioSelectWrapper").css('display', 'none');

        var fileSelector = $('<input type="file" accept="audio/*" multiple />');

        fileSelector[0].onchange = function(event) {
          loadLocalFiles(fileSelector[0].files);
        }

        fileSelector.click();
      });

      $("#micSelect").click(() => {
        $("#audioSelectWrapper").css('display', 'none');

        navigator.getUserMedia({ audio: true }, (stream) => {
          var micSourceNode = audioContext.createMediaStreamSource(stream);
          connectMicAudio(micSourceNode, audioContext);
        }, (err) => {
          console.log('Error getting audio stream from getUserMedia');
        });
      });

      $('#useWASM').change(() => {
        startPreset(currPresetIdx);
      });

      $('#presetSelect').change((evt) => {
        startPreset(parseInt($('#presetSelect').val()));
      });

      $(document).keydown((e) => {
        let newPresetVal;
        if (e.which === 32 || e.which === 39) {
          newPresetVal = (currPresetIdx + 1) % presetNames.length;
        } else if (e.which === 8 || e.which === 37) {
          if (currPresetIdx === 0) {
            newPresetVal = presetNames.length - 1;
          } else {
            newPresetVal = currPresetIdx - 1;
          }
        }
        if (newPresetVal != undefined) {
          $('#presetSelect').val(newPresetVal);
          startPreset(newPresetVal);
        }
      });

      function startPreset (presetIdx) {
        currPresetIdx = presetIdx;
        const preset = _.cloneDeep(parsedPresets[presetIdx]);
        preset.useWASM = $('#useWASM').is(':checked');
        // visualizer.loadPreset(preset, 3);
        visualizer.loadPreset(preset, 0);

        frameNum = 0;
        timeHist = [0];
      }

      function loadPreset(fileName) {
        return fetch('/experiments/wasm-eel/presets/' + fileName)
        .then((response) => {
          return response.json();
        });
      }

      function loadPresets() {
        Promise.all(presetNames.map(preset => loadPreset(preset))).then((presets) => {
          parsedPresets = presets;
          startPreset(0);
        });
      }

      function initPlayer() {
        audioContext = new AudioContext();
        visualizer = butterchurn.default.createVisualizer(audioContext, canvas , {
          width: 800,
          height: 600,
          pixelRatio: window.devicePixelRatio || 1,
          textureRatio: 1,
        });

        loadPresets();

        var presetSelect = document.getElementById('presetSelect');
        for(var i = 0; i < presetNames.length; i++) {
            var opt = document.createElement('option');
            opt.innerHTML = presetNames[i];
            opt.value = i;
            presetSelect.appendChild(opt);
        }
      }

      initPlayer();
    });
  </script>
</head>
<body>
  <div id="mainWrapper">
    <div id="audioSelectWrapper">
      <div id="remoteFileBut">
        <span>Load remote files</span>
      </div>
      <div id="localFileBut">
        <span>Load local files</span>
      </div>
      <div id="micSelect">
        <span>Use Mic</span>
      </div>
    </div>
    <div id="presetControls">
      <div>Preset: <select id="presetSelect"></select></div>
      <div>Use WASM: <input type="checkbox" id="useWASM" checked></input></div>
    </div>
    <canvas id='canvas' width='800' height='600'>
    </canvas>
  </div>
</body>
</html>
